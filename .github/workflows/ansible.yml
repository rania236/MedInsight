name: Ansible Operations

# Workflow pour les opÃ©rations Ansible (maintenance, backup, health checks)
# Peut Ãªtre dÃ©clenchÃ© manuellement ou planifiÃ©

on:
  # DÃ©clenchement manuel avec options
  workflow_dispatch:
    inputs:
      operation:
        description: 'OpÃ©ration Ã  exÃ©cuter'
        required: true
        type: choice
        options:
          - health-check
          - backup-databases
          - deploy-staging
          - deploy-prod
      environment:
        description: 'Environnement cible'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - prod

  # Backup automatique tous les jours Ã  2h du matin
  schedule:
    - cron: '0 2 * * *'

env:
  ANSIBLE_HOST_KEY_CHECKING: 'false'
  ANSIBLE_PYTHON_INTERPRETER: /usr/bin/python3

jobs:
  ansible-operation:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Ansible and dependencies
        run: |
          pip install ansible kubernetes openshift
          ansible-galaxy collection install kubernetes.core community.general

      - name: Setup SSH key
        env:
          SSH_PRIVATE_KEY: ${{ secrets.AWS_SSH_PRIVATE_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/medinsight-key.pem
          chmod 600 ~/.ssh/medinsight-key.pem
          
          # Add hosts to known_hosts
          ssh-keyscan -H 174.129.231.212 >> ~/.ssh/known_hosts 2>/dev/null || true
          ssh-keyscan -H 3.217.37.12 >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Setup kubeconfig
        env:
          KUBECONFIG_DATA: ${{ secrets.KUBECONFIG_DATA }}
        run: |
          mkdir -p ~/.kube
          echo "$KUBECONFIG_DATA" | base64 -d > ~/.kube/config

      - name: Run Health Check
        if: github.event.inputs.operation == 'health-check' || github.event_name == 'schedule'
        working-directory: ansible
        env:
          KUBECONFIG: ~/.kube/config
        run: |
          echo "ðŸ¥ Running cluster health check..."
          ansible-playbook playbooks/check-cluster-health.yml

      - name: Run Database Backup
        if: github.event.inputs.operation == 'backup-databases' || github.event_name == 'schedule'
        working-directory: ansible
        run: |
          echo "ðŸ’¾ Running database backup..."
          ansible-playbook playbooks/backup-databases.yml -e "env=${{ github.event.inputs.environment || 'staging' }}"

      - name: Deploy to Staging
        if: github.event.inputs.operation == 'deploy-staging'
        working-directory: ansible
        env:
          KUBECONFIG: ~/.kube/config
          IMAGE_TAG_PATIENT: ghcr.io/${{ github.repository_owner }}/patient-service:${{ github.sha }}
          IMAGE_TAG_DOCTOR: ghcr.io/${{ github.repository_owner }}/doctor-service:${{ github.sha }}
        run: |
          echo "ðŸš€ Deploying to staging with Ansible..."
          ansible-playbook playbooks/deploy-medinsight.yml \
            -e "env=staging" \
            -e "image_tag_patient=$IMAGE_TAG_PATIENT" \
            -e "image_tag_doctor=$IMAGE_TAG_DOCTOR"

      - name: Deploy to Production
        if: github.event.inputs.operation == 'deploy-prod'
        working-directory: ansible
        env:
          KUBECONFIG: ~/.kube/config
          IMAGE_TAG_PATIENT: ghcr.io/${{ github.repository_owner }}/patient-service:${{ github.sha }}
          IMAGE_TAG_DOCTOR: ghcr.io/${{ github.repository_owner }}/doctor-service:${{ github.sha }}
        run: |
          echo "ðŸš€ Deploying to production with Ansible..."
          ansible-playbook playbooks/deploy-medinsight.yml \
            -e "env=prod" \
            -e "image_tag_patient=$IMAGE_TAG_PATIENT" \
            -e "image_tag_doctor=$IMAGE_TAG_DOCTOR"

      - name: Upload health report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ansible-reports-${{ github.run_number }}
          path: ansible/reports/
          if-no-files-found: ignore

      - name: Summary
        run: |
          echo "## ðŸ“‹ Ansible Operation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Parameter | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Operation | ${{ github.event.inputs.operation || 'scheduled-backup' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | ${{ github.event.inputs.environment || 'staging' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Triggered by | ${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Status | âœ… Completed |" >> $GITHUB_STEP_SUMMARY
