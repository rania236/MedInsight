---
# Playbook: Health check optimis√© pour GitHub Actions
# Ex√©cute kubectl localement avec le kubeconfig configur√©
# Usage: ansible-playbook playbooks/check-cluster-health.yml

- hosts: localhost
  connection: local
  gather_facts: false

  vars:
    kubeconfig_path: "{{ lookup('env','KUBECONFIG') | default('~/.kube/config', true) }}"
    namespaces:
      - medinsight-staging
      - medinsight-prod

  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"
  
  tasks:
    - name: Validate kubeconfig is present
      stat:
        path: "{{ kubeconfig_path | default('/home/runner/.kube/config') }}"
      register: kubeconfig_stat
    
    - debug:
        var: kubeconfig_stat

    - name: Fail if kubeconfig is missing
      fail:
        msg: "Kubeconfig not found at {{ kubeconfig_path | default('/home/runner/.kube/config') }}. Ensure KUBECONFIG_DATA is set and decoded."
      when: not kubeconfig_stat.stat.exists

    - name: Show kubeconfig path
      debug:
        msg: "Using kubeconfig: {{ kubeconfig_path }}"

    - name: Show current kube context
      command: kubectl config current-context
      register: kube_context
      changed_when: false
      ignore_errors: true

    - name: Display kube context
      debug:
        msg: "Current context: {{ kube_context.stdout | default('unknown') }}"

    - name: Ensure reports directory exists
      file:
        path: "{{ playbook_dir }}/../reports"
        state: directory
        mode: '0755'

    - name: Get cluster info
      command: kubectl cluster-info
      register: cluster_info
      changed_when: false

    - name: Display cluster info
      debug:
        msg: "{{ cluster_info.stdout_lines }}"

    - name: Check cluster nodes status
      command: kubectl get nodes -o wide
      register: nodes_status
      changed_when: false

    - name: Display nodes status
      debug:
        msg: "{{ nodes_status.stdout_lines }}"

    - name: Check all pods in medinsight namespaces
      command: kubectl get pods -n {{ item }} -o wide
      loop: "{{ namespaces }}"
      register: pods_status
      ignore_errors: true
      changed_when: false

    - name: Display pods status
      debug:
        msg: |
          === {{ item.item }} ===
          {{ item.stdout | default('Namespace not found or empty') }}
      loop: "{{ pods_status.results }}"
      loop_control:
        label: "{{ item.item }}"

    - name: Check for pods not in Running state
      shell: |
        kubectl get pods -A --no-headers | grep -v Running | grep -v Completed || echo "‚úÖ All pods healthy"
      register: unhealthy_pods
      changed_when: false

    - name: Display unhealthy pods
      debug:
        msg: "{{ unhealthy_pods.stdout_lines }}"

    - name: Check PersistentVolumes
      command: kubectl get pv
      register: pv_status
      changed_when: false
      ignore_errors: true

    - name: Display PV status
      debug:
        msg: "{{ pv_status.stdout_lines | default(['No PVs found']) }}"

    - name: Check services in medinsight namespaces
      shell: kubectl get svc -A | grep -E 'medinsight|NAMESPACE'
      register: services_status
      changed_when: false
      ignore_errors: true

    - name: Display services
      debug:
        msg: "{{ services_status.stdout_lines | default(['No services found']) }}"

    - name: Check deployments status
      command: kubectl get deployments -A -o wide
      register: deployments_status
      changed_when: false

    - name: Display deployments
      debug:
        msg: "{{ deployments_status.stdout_lines }}"

    - name: Get recent events (warnings/errors)
      shell: |
        kubectl get events -A --sort-by='.lastTimestamp' | grep -E 'Warning|Error' | tail -20 || echo "No warnings or errors"
      register: events
      changed_when: false

    - name: Generate health report
      copy:
        dest: "{{ playbook_dir }}/../reports/cluster_health_report.txt"
        content: |
          ============================================
          MedInsight Cluster Health Report
          Generated: {{ lookup('pipe', 'date -Iseconds') }}
          ============================================
          
          CLUSTER INFO:
          {{ cluster_info.stdout }}
          
          NODES:
          {{ nodes_status.stdout }}
          
          UNHEALTHY PODS:
          {{ unhealthy_pods.stdout }}
          
          PERSISTENT VOLUMES:
          {{ pv_status.stdout | default('None') }}
          
          SERVICES:
          {{ services_status.stdout | default('None') }}
          
          DEPLOYMENTS:
          {{ deployments_status.stdout }}
          
          RECENT EVENTS (Warnings/Errors):
          {{ events.stdout }}
          ============================================

    - name: Health check summary
      debug:
        msg: |
          ============================================
          ‚úÖ Health Check Complete!
          üìÅ Full report saved to: reports/cluster_health_report.txt
          ============================================
